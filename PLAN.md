# 方案文档

## 目标
1. 实现 Telegram 账号级隔离，确保配置、数据、热键互不干扰。
2. 基于 Telegram 会话上下文自动匹配对应话术分类与列表。
3. 利用使用记录推导“下一个最佳话术”，提升成单与处理效率。

## 功能精简范围
- **删除搜索界面**：FollowWindow 与主界面不再提供人工搜索，全部依赖自动匹配与推荐逻辑。
- **移除 F1-F10 热键**：取消相关配置项与提示，避免与专注自动匹配的策略冲突。
- **关闭更新提醒**：去掉“现在更新/下次提醒/跳过版本”等 UI 和逻辑。
- 以上删减释放的 UI 空间用于展示账号信息、推荐链路与上下文提示。

## 系统拆分
- **Account Workspace**：以 Telegram `account_id` 建立独立工作区 `data/<account_id>/`，保存 SQLite、图片、临时缓存与 `setting.ini`。
- **配置隔离**：引入 `AccountConfig` 表（或 JSON），对吸附窗口、热键、语言等配置独立存储；启动时根据当前账号载入。
- **权限模型**：`AccountUser` 记录坐席/角色，界面仅展示被授权的账号与分类；敏感话术需额外审批标记。

## 账号角色话术流程
1. **管理员 (Admin)**
   - 新建账号工作区、导入基础分类；为每个账号绑定默认语言、阶段标签与推荐规则。
   - 维护 `AccountUser` 与 `RolePolicy`，定义角色可见的分类、是否允许编辑话术、是否能导出/备份。
   - 配置推荐策略（规则/模型阈值）并定期审查 `usage_log` 报表，淘汰低效话术。
2. **主管 (Supervisor)**
   - 接收推荐引擎的效果统计，复核命中率低的分类，安排精简或新增。
   - 通过 UI 审批敏感话术的启用/下线，向坐席广播最新流程。
   - 当账号切换或阶段变更时，可强制刷新推荐链，确保团队保持统一节奏。
3. **坐席 (Agent)**
   - 登录时选择被授权账号；界面自动加载对应分类并显示当前阶段。
   - 依据推荐区提供的 3 条候选直接点击发送；若推荐不适用，可选择“反馈”按钮以记录原因。
   - 双击任意话术卡片时，系统先清空输入框，再插入对应文本/图片引用并保持焦点，避免旧内容残留。
   - 每次交互自动写入 `usage_log`，包含成功/失败反馈，用于下一轮模型训练。

## 数据结构与迁移
- **账号表**：`accounts(id, telegram_handle, workspace_path, default_locale, status)`。
- **分类表**：`categories(id, account_id, label, position, tags)`；添加复合索引 `account_id + position`。
- **话术表**：`snippets(id, category_id, title, payload_type, text, media_ref, created_by, metrics)`。
- **使用日志**：`usage_log(id, account_id, telegram_chat, snippet_id, outcome, context_label, created_at)`。
- **标签/阶段**：`labels(id, account_id, name, keywords)`，并通过 `snippet_labels` 进行多对多绑定。
- 迁移流程：导出现有 `word_class/word_list`，按 `sign` 映射到新的 `categories/snippets`，为空字段提供默认值，图片引用迁移至 `media_ref`。
- **数据库优化**：统一使用外键约束、触发器维护引用完整性，引入 `attachments` 表管理图片/文件；在 `snippets` 与 `usage_log` 上创建 FTS5 虚拟表以加速上下文检索，并为高频查询字段（如 `account_id`、`category_id`、`telegram_chat`）建立覆盖索引。

## Telegram 场景识别
1. **窗口监听**：读取 Telegram Desktop 窗口标题（包含聊天名称/id），通过正则映射到 `telegram_chat`。
2. **账号匹配**：若检测到多账号登录，解析当前会话所属账号并切换到对应工作区。
3. **分类选择**：根据 `AccountCategoryRule`（账号→阶段→分类）自动定位列表，并提供 fallback 到通用分类。

## 使用记录与推荐
- **数据采集**：每次复制/发送/编辑记录一条 `usage_log`，包含上一条 snippet、客户状态、是否成功发送。
- **规则引擎**：基于阶段和关键词的决策表生成初步推荐链。
- **序列模型**：利用 Markov/PrefixSpan 分析 `usage_log`，为当前序列提供概率最高的下一条，并计算置信度。
- **个性化权重**：按账号与坐席分别维护评分，支持“非常有效/不再推荐”反馈闭环。

## 界面与交互
- FollowWindow 增加“推荐区”，展示 3 条优先话术（含推荐理由和快捷键）。
- 上下文指示条直接显示“当前账号/客户阶段/匹配分类”，并允许一键切换推荐结果。
- 为账号切换、推荐命中率等增加仪表板，便于运营跟踪。

## 安全与配置
- 所有工作区目录默认加密或至少通过 ACL 限制访问；备份时以 ZIP+密码形式输出。
- 生产环境禁用直接导出 `database.db`，提供脱敏/空模板供调试。
- 启用配置校验：若 `[adsorb-extend]` 出现未知键，阻止加载并提示修正。

## 里程碑
1. **Milestone A**：完成数据结构重构与迁移脚本，支持多个账号的基本读写。
2. **Milestone B**：实现 Telegram 会话识别、分类映射与推荐引擎 MVP。
3. **Milestone C**：完善 UI、反馈闭环、加密备份与监控面板，准备交付。

## 执行路线图
| 阶段 | 核心任务 | 负责人 | 预计周期 | 验收标准 |
| --- | --- | --- | --- | --- |
| A1 架构整理 | 评估现有 SQLite/资源文件，导出 schema；搭建多账号工作区目录模板 | 架构工程师 | 3 天 | 完成 schema 文档 + 目录脚本，`sqlite3 .schema` 与模板 diff 通过 |
| A2 数据迁移 | 实现 `word_class/word_list` → 新表的迁移程序，含图片搬迁与校验 | 数据工程师 | 4 天 | 100% 样本迁移成功，`PRAGMA foreign_key_check` 0 行 |
| B1 会话识别 | 开发 Telegram 窗口监听服务 & 账号映射配置 UI | 客户端工程师 | 5 天 | 同时登录多账号时可自动切换工作区，日志中 `account switched` 记录正确 |
| B2 推荐 MVP | 规则引擎 + 序列挖掘实现推荐接口，FollowWindow 展示推荐区 | 算法 + 前端 | 6 天 | 推荐区显示 3 条候选，UsageLog 中包含推荐来源字段 |
| C1 安全加固 | ACL/加密备份、配置校验、双击输入逻辑、无搜索改版 | 平台工程师 | 4 天 | 配置错误时 UI 可提示并阻断；双击插入行为录屏确认 |
| C2 交付评审 | 组织 Admin/Supervisor/Agent 实操演练，收集反馈 | 产品负责人 | 2 天 | 90% 以上关键用例通过，反馈问题记录在案 |

## 任务拆解与依赖
1. **配置/目录改造**（A1）先行，产出模板供后续开发复用。
2. **数据库迁移**（A2）依赖于架构整理；完成后才能开发推荐引擎和多账号逻辑。
3. **会话识别** 与 **推荐 MVP**（B1/B2）相互独立，但均依赖 UsageLog 新表结构。
4. **UI 改造 + 双击逻辑** 与 **安全校验**（C1）需在推荐 MVP 基础上进行，以便展示正确内容。
5. **交付评审**（C2）需所有功能完成并通过自测，包含 Admin/Supervisor/Agent 三角角色联调。

## 验收与回归
- 每阶段结束必须提交演示录屏 + 自检报告，覆盖账号切换、推荐点击、双击输入、数据写入等关键流程。
- 数据库迁移与推荐算法需提供自动化脚本（PowerShell 或 .NET 工具）可重复执行。
- 生产发布前执行回归：导入真实脱敏数据，运行 24h 压力测试并监控 UsageLog、Attachments 表增长。
- 若发现阻塞问题，回滚到上一个里程碑的稳定包，并在文档中记录补救计划。
