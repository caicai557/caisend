# 🎯 如何使用 Playwright 自动化功能

## ❓ 为什么 UI 没有变化？

**答案**: UI **不需要**变化！

### 解释

我们完成的是**后端功能**，前端 UI 已经存在：

```
前端 UI（已存在）         →  后端功能（新增）
────────────────────────────────────────────
[启动账号] 按钮         →  PlaywrightManager
                          (自动打开浏览器)
                          
[停止账号] 按钮         →  停止浏览器会话
                          
账号列表                →  显示运行状态
                          
系统托盘               →  新增托盘功能
```

---

## ✅ 现在可以做什么

### 之前的行为（Phase 6）
点击"启动账号" → 只是更新状态 → 没有实际动作

### 现在的行为（Phase 7）
点击"启动账号" → **打开浏览器** → 登录 Telegram → 自动监听消息 → 自动回复

---

## 🚀 完整使用流程

### 步骤 1: 确认依赖已安装 ✅

```bash
# Playwright 已安装
npm install playwright ✅

# Chromium 浏览器正在安装...
npx playwright install chromium
```

### 步骤 2: 重启应用

**重要**: 需要重启 Electron 才能加载新的后端代码！

```bash
# 停止当前运行的 Electron
# 然后重新启动

# 终端 1 (前端)
npm run dev

# 终端 2 (Electron - 新窗口)
npm run electron:dev
```

### 步骤 3: 创建账号

1. 点击侧边栏 **"添加账号"**
2. 填写信息：
   - 账号名称：例如 "测试账号1"
   - 手机号：你的手机号
   - 备注：可选
3. 点击 **"创建"**

### 步骤 4: 创建规则

1. 点击账号进入详情页
2. 切换到 **"规则"** 标签
3. 点击 **"添加规则"**
4. 配置规则：
   ```
   规则名称: 自动问候
   触发类型: 关键词
   匹配模式: 包含
   关键词: 你好
   响应内容: 你好！我是自动回复机器人 😊
   ```
5. 点击 **"保存"**

### 步骤 5: 启动账号 🎯

**这是关键步骤！**

1. 在账号详情页点击 **"启动"** 按钮
2. **现在会发生以下事情**：

   ```
   点击启动按钮
       ↓
   Playwright 启动浏览器 🌐
       ↓
   自动打开 Telegram Web
   (https://web.telegram.org/k/)
       ↓
   【首次使用】需要手动登录
   - 输入手机号
   - 输入验证码
   - 登录成功
       ↓
   后台开始监听消息（每5秒）
       ↓
   收到消息 → 匹配规则 → 自动回复 ✅
   ```

### 步骤 6: 测试自动回复

1. 用另一个账号给这个账号发消息
2. 发送包含 "你好" 的消息
3. **自动回复** 会在几秒内发出
4. 查看 **运行日志** 页面，可以看到：
   - 收到消息的日志
   - 规则匹配的日志
   - 发送回复的日志

---

## 👀 如何观察效果

### 1. 查看浏览器窗口
- 启动账号后会打开浏览器窗口
- 可以看到 Telegram Web 界面
- **不要关闭这个窗口**

### 2. 查看系统托盘
- 应用最小化后会在托盘显示
- 右键托盘图标可以看到菜单
- 显示运行中的账号数

### 3. 查看日志
- 点击左侧 **"运行日志"**
- 可以看到所有操作日志：
  - `[INFO] 正在启动 xxx 的浏览器会话...`
  - `[INFO] xxx 浏览器会话已启动`
  - `[DEBUG] 检测到新消息 [xxx]`
  - `[INFO] 收到消息: ...`
  - `[INFO] 规则匹配: xxx`
  - `[INFO] 正在发送回复: ...`
  - `[INFO] 回复已发送`

### 4. 查看仪表盘
- 点击左侧 **"仪表盘"**
- 查看：
  - 运行中账号数（应该 > 0）
  - 今日回复数（自动增长）
  - 活动时间线（显示所有操作）

---

## 🎬 预期效果演示

### 场景：自动客服

```
客户: 你好
机器人: 你好！我是自动回复机器人 😊

客户: 退货怎么办
机器人: 请提供您的订单号，我们会尽快处理。

客户: 价格多少
机器人: 请查看我们的价格表...
```

所有这些都是**自动完成**的！

---

## ⚠️ 常见问题

### Q1: 点击启动后没有打开浏览器？

**解决**:
1. 检查终端是否有错误信息
2. 确认 Chromium 已安装完成
3. 查看运行日志中的错误

### Q2: 浏览器打开了但是没有自动回复？

**可能原因**:
1. 没有登录 Telegram（首次需要手动登录）
2. 规则没有匹配到
3. 消息检测选择器需要调整

**调试方法**:
```typescript
// 在 Playwright 控制台查看日志
// 1. 查看日志页面
// 2. 筛选 [DEBUG] 级别
// 3. 查看消息检测日志
```

### Q3: 如何调试？

**方法 1: 查看日志**
- 运行日志页面
- 筛选 module: playwright

**方法 2: 截图**
```typescript
// 在前端调用
await window.electron.invoke('playwright:screenshot', { 
  accountId: 'xxx' 
})
```

**方法 3: 查看浏览器**
- 配置 `headless: false` （已配置）
- 可以直接看到浏览器操作

---

## 🔧 配置调整

### 修改轮询间隔

**文件**: `electron/managers/PlaywrightManager.ts`

```typescript
// 第 209 行
}, 5000) // 改为 3000 = 3秒检查一次
```

### 修改浏览器配置

**文件**: `electron/main.ts`

```typescript
// 第 383 行
const playwrightConfig = {
  headless: false,    // true = 无头模式（隐藏浏览器）
  timeout: 30000,     // 超时时间
  slowMo: 100         // 操作延迟（调试用）
}
```

---

## 📊 功能对比

| 功能 | Phase 6 (之前) | Phase 7 (现在) |
|------|----------------|----------------|
| 启动账号 | ✅ 更新状态 | ✅ **打开浏览器** |
| 消息监听 | ❌ 无 | ✅ **自动监听** |
| 自动回复 | ❌ 无 | ✅ **自动回复** |
| 系统托盘 | ❌ 无 | ✅ **支持** |
| 截图调试 | ❌ 无 | ✅ **支持** |

---

## ✅ 检查清单

使用前请确认：

- [ ] Playwright 已安装 (`npm install playwright`)
- [ ] Chromium 已下载 (`npx playwright install chromium`)
- [ ] Electron 已重启 (关闭并重新运行 `npm run electron:dev`)
- [ ] 已创建账号
- [ ] 已创建规则
- [ ] 点击了"启动"按钮
- [ ] 浏览器已打开
- [ ] 已登录 Telegram（首次）
- [ ] 可以在日志中看到 `[INFO] 浏览器会话已启动`

---

## 🎉 成功标志

当你看到以下情况，说明功能正常运行：

1. ✅ 点击启动后浏览器自动打开
2. ✅ 登录 Telegram 后保持打开状态
3. ✅ 日志显示 "正在检查新消息"
4. ✅ 收到测试消息后自动回复
5. ✅ 仪表盘显示运行中账号数 > 0
6. ✅ 系统托盘显示账号数

---

## 📞 需要帮助？

查看详细文档：
- `PLAYWRIGHT_COMPLETE.md` - Playwright 功能详解
- `QUICK_START.md` - 快速开始
- `DEPENDENCIES.md` - 依赖安装

---

**现在开始体验 Playwright 自动化功能吧！** 🚀
