<!--
Sync Impact Report
Version: 2.0.0 → 2.0.1 (PATCH)
Rationale: 澄清多节点流程引擎的设计原则和实现时机，无向后不兼容变更

Modified principles:
- 四、功能边界与重点：
  * 第4项（关键词自动回复）补充"单节点"说明
  * v2.0 扩展功能中补充多节点流程引擎的详细设计原则

Clarifications added:
- MVP 仅实现单节点关键词规则（单条规则命中 → 延时 → 回复）
- 多节点流程引擎设计原则：数据模型保持可扩展，但不实现具体流程逻辑

Templates requiring updates:
- ⚠ spec.md：确认已删除 FR-038 至 FR-041（多节点流程功能需求）
- ⚠ plan.md：确认不包含多节点流程引擎设计章节

Follow-up TODOs:
- 无（本次为澄清性更新）
-->

# Telegram Web 助手项目宪法

## 项目宗旨

本项目旨在通过 Telegram Web 自动化技术，为 Windows 用户提供智能消息管理助手。项目坚持**简单、可靠、可维护**的原则，通过 YAML 配置驱动实现灵活的自动化管理，不依赖任何 Telegram 官方 API。

MVP 核心功能包括：**单账号**管理、**单聊天**监控、基于**关键词的自动回复**（含延时抖动）、**自动已读**标记。

扩展功能（MVP 稳定后）包括：多账号独立运行、群组自动加入、截图数字识别（OCR）、桌面端图形界面等。

---

## 核心原则

### 一、代码与工程质量（强制执行）

**必须遵守**：

1. **类型安全**：所有函数签名、类属性、关键变量必须使用 Python 类型提示（Type Hints），确保 mypy 静态检查通过
2. **结构清晰**：每个模块职责单一，命名清晰，避免循环依赖
3. **代码风格**：遵循 PEP 8 规范，使用 `black` 或 `ruff` 自动格式化
4. **核心测试**：关键逻辑（规则匹配、延时计算、状态机）必须具备单元测试覆盖

**应当遵守**：

1. **最小依赖**：避免引入不必要的框架和库，优先使用 Python 标准库
2. **文档字符串**：关键函数和类包含 docstring，说明参数、返回值和副作用

**理由**：类型标注可在开发阶段暴露错误，测试保障核心逻辑正确性，最小依赖降低安装和维护成本。

### 二、架构风格（单体应用 + MVP 优先）

**必须遵守**：

1. **单代码库**：所有代码集中在一个仓库，采用单体应用架构
2. **模块划分**：按职责划分为配置（config）、数据模型（models）、规则引擎（engine）、Telegram Web 集成（telegram_web）、CLI 运行时（cli/runtime）、日志监控（logging）等模块
3. **MVP 严格定义**：最小可用产品（MVP）**仅包含**单账号、单聊天、关键词自动回复（含延时）、自动已读、命令行界面（CLI）

**应当遵守**：

1. **避免过度设计**：不预先实现未明确需求的功能（如多节点流程引擎、插件系统、云端同步、复杂权限管理、桌面 UI）
2. **渐进式扩展**：MVP 稳定后（通过验收测试并运行至少 1 周无重大问题），才可启动扩展功能开发

**实现纪律**（CRITICAL）：

1. **禁止提前实现**：任何标记为"v1.1+"或"v2.0"的功能，在 MVP 未稳定前**禁止**编写实现代码
2. **文档不得超前**：技术文档（spec.md, plan.md）不得包含未计划在当前版本实现的详细设计（如状态机、环检测算法）
3. **配置保持简单**：MVP 阶段配置文件结构必须保持最简（账号、聊天列表、规则列表），不引入复杂嵌套或预留字段

**理由**：单体架构降低开发和运维复杂度，模块化设计便于理解和扩展。MVP 优先确保核心价值快速验证，避免过度设计导致的范围蔓延和交付延期。严格的实现纪律防止"预留设计"变成实际开发负担。

### 三、平台与技术约束（技术栈）

**必须遵守**：

1. **运行平台**：Windows + Python 3.11 或更高版本
2. **自动化方案**：通过 Playwright 控制 Telegram Web（<https://web.telegram.org>），不使用 Telegram 官方 Bot API 或 User API
3. **会话持久化**：支持后台运行和持久会话，用户登录一次后可长期复用浏览器数据目录
4. **配置格式**：**唯一**使用 YAML 格式（通过 pyyaml 库解析），不支持 JSON 或其他格式

**MVP 核心依赖**（最小集合）：

- Playwright（浏览器自动化）
- pyyaml（YAML 配置解析）
- Pydantic（数据模型与配置验证）
- click（命令行界面）

**可选扩展依赖**（MVP 后添加）：

- Pillow + pytesseract（OCR 识别，v1.2+）
- Electron/PyQt/Tauri（桌面 UI，v1.1+）

**理由**：明确技术选型减少歧义，Telegram Web 自动化方式规避官方 API 限制，持久会话提升用户体验。YAML 格式统一配置标准，降低解析复杂度。最小依赖集合确保 MVP 快速交付。

### 四、功能边界与重点（MVP 与版本路线图）

**MVP 核心能力**（v1.0，必须实现）：

1. **单账号管理**：支持配置**一个** Telegram 账号，通过 CLI 启动运行
2. **单聊天监控**：监控**一个**私聊对象的新消息（通过用户名或聊天名称指定）
3. **自动已读**：检测到新消息后，自动滚动并标记为已读
4. **单节点关键词自动回复**：基于字面量关键词 + 通配符（`*`、`?`）匹配规则，自动回复预设文本。MVP 仅实现**单节点模式**（单条规则命中 → 延时 → 回复），不实现多节点流程引擎
5. **延时配置**：支持固定延时 + 随机延时（0 到配置上限），模拟真人响应速度
6. **YAML 配置驱动**：所有行为通过 YAML 配置文件定义，支持配置校验和错误提示
7. **命令行界面**：提供 `teleflow run --account <name> --config <path>` 等 CLI 命令

**v1.0 MVP 不包含**（明确排除）：

- ❌ 多账号同时运行
- ❌ 群组加入与欢迎消息
- ❌ OCR 数字识别
- ❌ 桌面端图形界面
- ❌ 多节点流程引擎

**扩展功能路线图**：

**v1.1**（MVP 稳定后 3-4 周）：

- 多账号独立运行（一账号一进程模式）
- 群组自动加入与欢迎消息发送
- 日志系统完善（按天轮转、结构化输出）

**v1.2**（v1.1 稳定后 3-4 周）：

- OCR 数字识别（Tesseract，支持验证码场景）
- 桌面端 UI 基础版（只读监控：账号状态、日志查看）

**v1.3+**（v1.2 稳定后按需规划）：

- 桌面端 UI 完整版（配置编辑、账号管理、实时监控）
- 正则表达式支持（高级关键词匹配）
- 发送者过滤、时间窗口等高级匹配条件

**v2.0**（需求明确后再启动）：

- **多节点流程引擎**（**仅在用户明确需求复杂对话流程时实现**）：
  - 支持按节点顺序执行的流程引擎（节点 → 判定 → 动作 → 跳转）
  - 支持流程状态持久化与节点跳转逻辑
  - **设计原则**：当前版本（v1.0-v1.3）在实现规则匹配和数据模型时，应保持接口可扩展性，为后续增加"节点、跳转、状态"预留设计空间，但**不实现**具体的多节点流程逻辑、状态机或环检测算法
  - **触发条件**：仅在多个用户明确反馈需要复杂对话流程（如多轮问答、条件分支、状态记忆）时，才启动 v2.0 开发
- 跨平台支持（macOS、Linux）

**理由**：明确功能边界避免范围蔓延，版本路线图确保渐进式交付。MVP 专注核心价值验证，扩展功能基于用户反馈和实际需求迭代。

### 五、配置驱动与扩展性（配置管理）

**必须遵守**：

1. **配置驱动**：所有业务行为（匹配规则、延时策略、回复内容、聊天列表）均通过 YAML 配置文件定义，不在代码中硬编码
2. **YAML 唯一格式**：配置文件**必须**使用 YAML 格式（.yaml 或 .yml 扩展名），通过 pyyaml 库解析
3. **配置校验**：启动时必须校验配置文件格式和内容完整性（使用 Pydantic 模型），错误时拒绝启动并输出详细错误信息
4. **配置路径可指定**：配置文件路径通过命令行参数 `--config` 指定，默认为 `./config.yaml`

**MVP 配置结构**（最简示例）：

```yaml
account:
  name: "my_account"
  browser_data_dir: "./browser_data/my_account"  # 可选，默认使用账号名称
  
chat:
  identifier: "@friend_username"  # 用户名或聊天名称
  
rules:
  - keywords: ["你好", "hello"]
    reply_text: "你好！有什么可以帮助你的吗？"
    fixed_delay: 2.0  # 秒
    random_delay_max: 3.0  # 秒
    case_sensitive: false  # 默认不区分大小写
```

**扩展功能配置**（v1.1+ 才支持）：

- 多账号配置：`accounts:` 列表（每个账号独立配置）
- 群组配置：`groups:` 列表（邀请链接 + 欢迎消息）
- OCR 配置：`ocr: enabled: true`（v1.2+）

**理由**：配置驱动提高灵活性，用户无需修改代码即可调整规则。YAML 格式统一降低解析复杂度，避免 JSON/YAML 双重兼容的维护成本。Pydantic 校验确保配置正确性，减少运行时错误。

---

## 运行特性与可观测性

**必须遵守**：

1. **结构化日志**：记录关键事件（收到消息摘要、匹配规则、延时计算、发送回复、异常错误）
2. **调试模式**：提供 `--debug` 参数，输出详细的决策过程和中间状态
3. **稳定性优先**：遇到异常（选择器失效、页面结构变化、网络错误）时，记录错误并重试或跳过，不导致整体崩溃
4. **日志输出**：MVP 阶段日志输出到控制台和文件（`./logs/teleflow.log`），人类可读格式优先

**日志级别**（MVP）：

- ERROR：异常情况（选择器失效、网络错误、配置错误、启动失败）
- WARNING：可恢复的问题（规则未匹配、页面加载超时）
- INFO：关键事件（账号启动、收到消息、匹配规则、发送回复）
- DEBUG：详细信息（页面元素状态、规则匹配中间结果、延时计算过程）

**扩展功能**（v1.1+）：

- 结构化日志格式（JSON Lines，便于机器解析）
- 日志按天轮转（`TimedRotatingFileHandler`）
- 日志级别动态调整（通过配置文件或命令行参数）

**理由**：完善的日志便于排查问题，调试模式提升开发效率，稳定性优先保障长期运行。MVP 阶段使用人类可读格式降低学习成本，扩展功能提供高级日志管理。

## 可扩展性设计

**必须遵守**：

1. **数据模型抽象**：使用 Pydantic 定义消息、规则、账号、聊天等核心数据结构，便于序列化和验证
2. **模块接口清晰**：规则引擎（matcher.py）、Telegram 集成（telegram_web/）、配置管理（config/）提供清晰的接口，便于独立测试和替换实现
3. **配置向后兼容**：配置文件格式变更时，提供向后兼容读取或迁移工具（v1.1+ 开始考虑）

**MVP 扩展预留**：

1. **账号抽象**：MVP 使用单账号配置（`account:`），v1.1 扩展为账号列表（`accounts:`）时无需重构核心逻辑
2. **聊天抽象**：MVP 使用单聊天配置（`chat:`），v1.1 扩展为聊天列表（`chats:`）时保持数据模型一致
3. **规则引擎接口**：规则匹配器（RuleMatcher）接口设计支持未来扩展（正则表达式、复杂条件），但 MVP 仅实现字面量 + 通配符

**未来扩展方向**（需求明确后再实现）：

1. **更多匹配条件**（v1.3+）：正则表达式、发送者白名单/黑名单、时间窗口、消息类型过滤
2. **更多平台**（v2.0+）：WhatsApp Web、微信网页版等类似 Web 自动化场景
3. **OCR 增强**（v1.2+）：支持更多语言、更复杂的图像识别（验证码、表格、OCR API 集成）

**理由**：清晰的模块边界和数据抽象为未来扩展奠定基础，但 MVP 不实现预留设计。向后兼容降低升级成本，接口设计允许独立演进。

## 治理规则

**宪法权威**：

- 本宪法是项目开发的最高准则，所有设计和实现决策必须符合宪法原则
- 违反宪法的代码不得合并到主分支

**修订流程**：

- 宪法修订需经过讨论、文档更新、版本号变更三个步骤
- 重大原则变更（MAJOR 版本）需提供迁移指南
- 澄清和措辞优化（PATCH 版本）可快速通过

**版本规则**：

- 遵循语义化版本号（MAJOR.MINOR.PATCH）
- MAJOR：向后不兼容的原则变更或删除
- MINOR：新增原则或扩展现有原则
- PATCH：澄清措辞、修正错误

**Version**: 2.0.1 | **Ratified**: 2025-01-16 | **Last Amended**: 2025-01-16
