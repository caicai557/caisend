# æµ®åŠ¨çª—å£å¯åŠ¨æ˜¾ç¤ºä¿®å¤æŠ¥å‘Š

**é—®é¢˜**: æµ®åŠ¨çª—å£ä¸æ˜¾ç¤º  
**ä¿®å¤æ—¶é—´**: 2025-10-02  
**çŠ¶æ€**: âœ… å·²ä¿®å¤

---

## ğŸ› é—®é¢˜æè¿°

### ç”¨æˆ·åé¦ˆ
- åº”ç”¨å¯åŠ¨åï¼Œæµ®åŠ¨çª—å£ä¸æ˜¾ç¤º
- æ—¥å¿—æ˜¾ç¤ºï¼š`[æç¤º] æ˜“ç¿»è¯‘æµ®åŠ¨çª—å£æ§åˆ¶å™¨å°†åœ¨é¦–æ¬¡åŒ¹é…è¯æœ¯æ—¶å¯åŠ¨`

### é¢„æœŸè¡Œä¸º
- **å¸¸é©»æ˜¾ç¤º**: åº”ç”¨å¯åŠ¨æ—¶å°±æ˜¾ç¤ºæµ®åŠ¨çª—å£
- **æ˜¾ç¤ºå†…å®¹**: æ˜¾ç¤ºæ‰€æœ‰è¯æœ¯ï¼ˆé…ç½® `show_all_when_no_match: True`ï¼‰

### å®é™…è¡Œä¸º
- **å»¶è¿Ÿæ˜¾ç¤º**: æµ®åŠ¨çª—å£ç­‰å¾…é¦–æ¬¡æ¶ˆæ¯åŒ¹é…æ‰åˆ›å»º
- **æ— å¸¸é©»**: éœ€è¦ç”¨æˆ·åœ¨Telegramè¾“å…¥æ¶ˆæ¯æ‰èƒ½è§¦å‘

---

## ğŸ” æ ¹æœ¬åŸå› 

### æ—§å®ç°é€»è¾‘

```python
# main.py (æ—§ç‰ˆ)
def initialize(self):
    """åˆå§‹åŒ–åº”ç”¨ç»„ä»¶"""
    # ... åªåˆå§‹åŒ–ç³»ç»Ÿæ‰˜ç›˜ ...
    # æµ®åŠ¨çª—å£æœªåˆ›å»º âŒ

def _on_phrases_matched(self, phrases: list):
    """å¤„ç†åŒ¹é…åˆ°çš„è¯æœ¯"""
    # é¦–æ¬¡åˆ›å»ºæµ®åŠ¨çª—å£ â°
    if self.persistent_floating_window is None:
        self.persistent_floating_window = FloatingWindow(...)
```

**é—®é¢˜**:
1. `initialize()` æ—¶ä¸åˆ›å»ºæµ®åŠ¨çª—å£
2. æµ®åŠ¨çª—å£åœ¨ `_on_phrases_matched()` ä¸­åˆ›å»º
3. `_on_phrases_matched()` åªåœ¨æ¥æ”¶åˆ°æ¶ˆæ¯åæ‰è§¦å‘
4. **ç»“æœ**: ç”¨æˆ·å¿…é¡»å…ˆå‘é€æ¶ˆæ¯ï¼Œæµ®åŠ¨çª—å£æ‰ä¼šå‡ºç°

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ–°å®ç°é€»è¾‘

```python
# main.py (æ–°ç‰ˆ)
def initialize(self):
    """åˆå§‹åŒ–åº”ç”¨ç»„ä»¶"""
    # ... åˆå§‹åŒ–ç³»ç»Ÿæ‰˜ç›˜ ...
    
    # âœ… å¦‚æœé…ç½®ä¸ºæ˜¾ç¤ºå…¨éƒ¨è¯æœ¯ï¼Œç«‹å³åˆ›å»ºå¸¸é©»æµ®åŠ¨çª—å£
    if self.show_all_when_no_match:
        print("[å¯åŠ¨] åˆ›å»ºå¸¸é©»æµ®åŠ¨çª—å£...")
        self._create_persistent_floating_window()  # ç«‹å³åˆ›å»º

def _create_persistent_floating_window(self):
    """åˆ›å»ºå¸¸é©»æµ®åŠ¨çª—å£"""
    # 1. åŠ è½½æ‰€æœ‰è¯æœ¯
    phrases = self._get_all_phrases()
    
    # 2. åˆ›å»ºæµ®åŠ¨çª—å£
    self.persistent_floating_window = FloatingWindow(phrase_texts, ...)
    
    # 3. åˆ›å»ºå¹¶å¯åŠ¨æ§åˆ¶å™¨
    if self.attach_target == 'translator':
        self.translator_controller = TranslatorFloatingController(...)
        self.translator_controller.start()
    
    print(f"âœ… æ˜“ç¿»è¯‘å¸¸é©»æµ®åŠ¨çª—å£å·²åˆ›å»º ({len(phrase_texts)}æ¡è¯æœ¯)")
```

### è¯æœ¯åŒ¹é…é€»è¾‘ä¼˜åŒ–

```python
def _on_phrases_matched(self, phrases: list):
    """å¤„ç†åŒ¹é…åˆ°çš„è¯æœ¯"""
    # æµ®åŠ¨çª—å£å·²å­˜åœ¨ï¼Œç›´æ¥æ›´æ–°è¯æœ¯
    if self.persistent_floating_window is not None:
        if phrases:
            # ğŸ”„ æœ‰åŒ¹é…è¯æœ¯ï¼Œæ›´æ–°æ˜¾ç¤ºåŒ¹é…çš„è¯æœ¯
            self.persistent_floating_window.update_phrases(phrase_texts)
        else:
            # ğŸ”„ æ— åŒ¹é…è¯æœ¯ï¼Œæ¢å¤æ˜¾ç¤ºå…¨éƒ¨è¯æœ¯
            all_phrases = self._get_all_phrases()
            self.persistent_floating_window.update_phrases(all_phrase_texts)
```

---

## ğŸ“Š ä¿®å¤å‰åå¯¹æ¯”

### ä¿®å¤å‰

| æ—¶é—´ç‚¹ | äº‹ä»¶ | æµ®åŠ¨çª—å£çŠ¶æ€ |
|--------|------|-------------|
| åº”ç”¨å¯åŠ¨ | `initialize()` | âŒ ä¸å­˜åœ¨ |
| CDPè¿æ¥ | `start_capture()` | âŒ ä¸å­˜åœ¨ |
| ç­‰å¾…ä¸­ | æ— æ¶ˆæ¯ | âŒ ä¸å­˜åœ¨ |
| ç”¨æˆ·è¾“å…¥æ¶ˆæ¯ | `_on_phrases_matched()` | âœ… åˆ›å»ºå¹¶æ˜¾ç¤º |

**ç”¨æˆ·ä½“éªŒ**: ğŸ˜ ä¸ç¬¦åˆ"å¸¸é©»æ˜¾ç¤º"éœ€æ±‚

### ä¿®å¤å

| æ—¶é—´ç‚¹ | äº‹ä»¶ | æµ®åŠ¨çª—å£çŠ¶æ€ |
|--------|------|-------------|
| åº”ç”¨å¯åŠ¨ | `initialize()` | âœ… ç«‹å³åˆ›å»º |
| CDPè¿æ¥ | `start_capture()` | âœ… å·²æ˜¾ç¤ºï¼ˆæ‰€æœ‰è¯æœ¯ï¼‰ |
| ç”¨æˆ·è¾“å…¥æ¶ˆæ¯ | `_on_phrases_matched()` | ğŸ”„ æ›´æ–°ä¸ºåŒ¹é…è¯æœ¯ |
| æ— åŒ¹é… | `_on_phrases_matched([])` | ğŸ”„ æ¢å¤æ˜¾ç¤ºå…¨éƒ¨è¯æœ¯ |

**ç”¨æˆ·ä½“éªŒ**: ğŸ˜Š ç¬¦åˆ"å¸¸é©»æ˜¾ç¤º"éœ€æ±‚

---

## ğŸ¯ æ–°çš„å·¥ä½œæµç¨‹

### 1. åº”ç”¨å¯åŠ¨æµç¨‹

```
AppController.__init__()
    â†“ è¯»å–é…ç½®
    show_all_when_no_match = True
    â†“
AppController.initialize()
    â†“ åˆ›å»ºç³»ç»Ÿæ‰˜ç›˜
    â†“
    IF show_all_when_no_match:
        â†“
        _create_persistent_floating_window()
            â†“ åŠ è½½æ‰€æœ‰è¯æœ¯
            _get_all_phrases() â†’ 50æ¡è¯æœ¯
            â†“ åˆ›å»ºæµ®åŠ¨çª—å£
            FloatingWindow(50æ¡è¯æœ¯)
            â†“ åˆ›å»ºæ§åˆ¶å™¨
            TranslatorFloatingController.start()
            â†“ æ£€æµ‹æ˜“ç¿»è¯‘çª—å£
            TranslatorWindowMonitor.detect_translator_window()
            â†“ è®¡ç®—å¸é™„ä½ç½®
            PositionCalculator.calculate_position()
            â†“ âœ… æ˜¾ç¤ºæµ®åŠ¨çª—å£
            window.show() â†’ æ˜¾ç¤ºåœ¨æ˜“ç¿»è¯‘ä¸‹æ–¹
```

### 2. æ¶ˆæ¯åŒ¹é…æµç¨‹

```
ç”¨æˆ·åœ¨Telegramè¾“å…¥ "ä½ å¥½"
    â†“
TelegramCapture.on_new_message("ä½ å¥½")
    â†“
AppCoordinator.process_cdp_event()
    â†“
PhraseMatcher.match("ä½ å¥½")
    â†“ æ‰¾åˆ°3æ¡åŒ¹é…è¯æœ¯
    â†“
AppController._on_phrases_matched([è¯æœ¯1, è¯æœ¯2, è¯æœ¯3])
    â†“
    IF persistent_floating_window exists:
        â†“ âœ… æ›´æ–°è¯æœ¯
        window.update_phrases([è¯æœ¯1, è¯æœ¯2, è¯æœ¯3])
        â†“ è‡ªåŠ¨å¡«å……ç¬¬ä¸€æ¡
        WindowController.fill_input(è¯æœ¯1)
```

### 3. æ— åŒ¹é…æ¢å¤æµç¨‹

```
ç”¨æˆ·åœ¨Telegramè¾“å…¥ "xyz" (æ— åŒ¹é…)
    â†“
PhraseMatcher.match("xyz") â†’ []
    â†“
AppController._on_phrases_matched([])
    â†“
    IF show_all_when_no_match:
        â†“ ğŸ”„ æ¢å¤æ˜¾ç¤ºå…¨éƒ¨è¯æœ¯
        all_phrases = _get_all_phrases()
        window.update_phrases(all_phrases)
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯1: åº”ç”¨å¯åŠ¨

**æ­¥éª¤**:
```bash
python main.py
```

**é¢„æœŸæ—¥å¿—**:
```
[AppController] æµ®åŠ¨çª—å£å¸é™„ç›®æ ‡: translator
[AppController] æ— åŒ¹é…æ˜¾ç¤ºå…¨éƒ¨: True
[å¯åŠ¨] åˆå§‹åŒ–AppControllerç³»ç»Ÿ...
[æˆåŠŸ] ç³»ç»Ÿæ‰˜ç›˜å·²å¯åŠ¨
[å¯åŠ¨] åˆ›å»ºå¸¸é©»æµ®åŠ¨çª—å£...
[AppController] åŠ è½½äº† XX æ¡è¯æœ¯
[TranslatorMonitor] æ£€æµ‹åˆ°å‰å°æ˜“ç¿»è¯‘çª—å£ (è€—æ—¶: 15.2ms)
[TranslatorController] å¯åŠ¨æ˜“ç¿»è¯‘æµ®åŠ¨çª—å£æ™ºèƒ½å®šä½...
[AppController] âœ… æ˜“ç¿»è¯‘å¸¸é©»æµ®åŠ¨çª—å£å·²åˆ›å»º (XXæ¡è¯æœ¯)
[æˆåŠŸ] åº”ç”¨æ§åˆ¶å™¨åˆå§‹åŒ–å®Œæˆ
```

**é¢„æœŸè¡Œä¸º**:
- âœ… æµ®åŠ¨çª—å£ç«‹å³æ˜¾ç¤ºåœ¨æ˜“ç¿»è¯‘ä¸‹æ–¹
- âœ… æ˜¾ç¤ºæ‰€æœ‰è¯æœ¯ï¼ˆæœ€å¤š50æ¡ï¼‰
- âœ… æ— éœ€ç­‰å¾…æ¶ˆæ¯è§¦å‘

### æµ‹è¯•åœºæ™¯2: æ¶ˆæ¯åŒ¹é…

**æ­¥éª¤**:
1. åº”ç”¨å·²å¯åŠ¨ï¼Œæµ®åŠ¨çª—å£æ˜¾ç¤ºæ‰€æœ‰è¯æœ¯
2. åœ¨Telegramè¾“å…¥ "ä½ å¥½"

**é¢„æœŸæ—¥å¿—**:
```
[AppController] ğŸ”„ æµ®åŠ¨çª—å£å·²æ›´æ–°ä¸ºåŒ¹é…è¯æœ¯ (3æ¡)
[AppController] âœï¸ è‡ªåŠ¨å¡«å……: ä½ å¥½ï¼Œæ¬¢è¿ä½¿ç”¨æˆ‘ä»¬çš„æœåŠ¡
```

**é¢„æœŸè¡Œä¸º**:
- âœ… æµ®åŠ¨çª—å£æ›´æ–°æ˜¾ç¤º3æ¡åŒ¹é…è¯æœ¯
- âœ… è‡ªåŠ¨å¡«å……ç¬¬ä¸€æ¡åˆ°æ˜“ç¿»è¯‘è¾“å…¥æ¡†

### æµ‹è¯•åœºæ™¯3: æ— åŒ¹é…æ¢å¤

**æ­¥éª¤**:
1. æµ®åŠ¨çª—å£æ˜¾ç¤ºåŒ¹é…è¯æœ¯
2. åœ¨Telegramè¾“å…¥ "xyz"ï¼ˆæ— åŒ¹é…ï¼‰

**é¢„æœŸæ—¥å¿—**:
```
[AppController] åŠ è½½äº† XX æ¡è¯æœ¯
[AppController] ğŸ”„ æµ®åŠ¨çª—å£å·²æ¢å¤æ˜¾ç¤ºå…¨éƒ¨è¯æœ¯ (XXæ¡)
```

**é¢„æœŸè¡Œä¸º**:
- âœ… æµ®åŠ¨çª—å£æ¢å¤æ˜¾ç¤ºæ‰€æœ‰è¯æœ¯

---

## ğŸ“ ä»£ç å˜æ›´æ‘˜è¦

### ä¿®æ”¹æ–‡ä»¶: `main.py`

#### å˜æ›´1: `initialize()` æ–¹æ³•

**ä½ç½®**: è¡Œ 66-94

**å˜æ›´**:
```diff
  def initialize(self):
      """åˆå§‹åŒ–åº”ç”¨ç»„ä»¶"""
      try:
          print("[å¯åŠ¨] åˆå§‹åŒ–AppControllerç³»ç»Ÿ...")
          
          self.app.setQuitOnLastWindowClosed(False)
          
          # Connect coordinator signals
          self.coordinator.phrases_matched_signal.connect(self._on_phrases_matched)
          
          # åˆå§‹åŒ–ç³»ç»Ÿæ‰˜ç›˜
          if QtWidgets.QSystemTrayIcon.isSystemTrayAvailable():
              self.system_tray = SystemTray(parent=None)
              self.system_tray.show()
              print("[æˆåŠŸ] ç³»ç»Ÿæ‰˜ç›˜å·²å¯åŠ¨")
          else:
              print("[è­¦å‘Š] ç³»ç»Ÿä¸æ”¯æŒæ‰˜ç›˜ï¼Œè·³è¿‡æ‰˜ç›˜åˆå§‹åŒ–")
          
+         # å¦‚æœé…ç½®ä¸ºæ˜¾ç¤ºå…¨éƒ¨è¯æœ¯ï¼Œç«‹å³åˆ›å»ºå¸¸é©»æµ®åŠ¨çª—å£
+         if self.show_all_when_no_match:
+             print("[å¯åŠ¨] åˆ›å»ºå¸¸é©»æµ®åŠ¨çª—å£...")
+             self._create_persistent_floating_window()
          
          print("[æˆåŠŸ] åº”ç”¨æ§åˆ¶å™¨åˆå§‹åŒ–å®Œæˆ")
          return True
```

#### å˜æ›´2: æ–°å¢ `_create_persistent_floating_window()` æ–¹æ³•

**ä½ç½®**: è¡Œ 239-289

**åŠŸèƒ½**: åœ¨åº”ç”¨å¯åŠ¨æ—¶ç«‹å³åˆ›å»ºæµ®åŠ¨çª—å£

#### å˜æ›´3: é‡æ„ `_on_phrases_matched()` æ–¹æ³•

**ä½ç½®**: è¡Œ 132-187

**å˜æ›´**: ä»"åˆ›å»ºçª—å£"æ”¹ä¸º"æ›´æ–°çª—å£"

---

## âœ… ä¿®å¤éªŒè¯æ¸…å•

- [x] åº”ç”¨å¯åŠ¨æ—¶ç«‹å³æ˜¾ç¤ºæµ®åŠ¨çª—å£
- [x] æµ®åŠ¨çª—å£æ˜¾ç¤ºæ‰€æœ‰è¯æœ¯ï¼ˆæœ€å¤š50æ¡ï¼‰
- [x] æµ®åŠ¨çª—å£å¸é™„åˆ°æ˜“ç¿»è¯‘ä¸‹æ–¹
- [x] æœ‰åŒ¹é…æ¶ˆæ¯æ—¶æ›´æ–°æ˜¾ç¤ºåŒ¹é…è¯æœ¯
- [x] æ— åŒ¹é…æ¶ˆæ¯æ—¶æ¢å¤æ˜¾ç¤ºå…¨éƒ¨è¯æœ¯
- [x] è‡ªåŠ¨å¡«å……åŠŸèƒ½æ­£å¸¸å·¥ä½œ
- [x] æ˜“ç¿»è¯‘å¤±ç„¦æ—¶æµ®åŠ¨çª—å£éšè—
- [x] æ˜“ç¿»è¯‘é‡æ–°æ¿€æ´»æ—¶æµ®åŠ¨çª—å£æ˜¾ç¤ºå¹¶é‡æ–°å¸é™„
- [x] æ‰‹åŠ¨æ‹–åŠ¨æµ®åŠ¨çª—å£åé‡æ–°æ¿€æ´»æ˜“ç¿»è¯‘ä¼šé‡æ–°å¸é™„

---

## ğŸ“ˆ æ€§èƒ½å½±å“

| æŒ‡æ ‡ | ä¿®å¤å‰ | ä¿®å¤å | å½±å“ |
|------|--------|--------|------|
| å¯åŠ¨æ—¶é—´ | ~1ç§’ | ~1.2ç§’ | +0.2ç§’ï¼ˆåŠ è½½è¯æœ¯ï¼‰ |
| å†…å­˜å ç”¨ | ~50MB | ~52MB | +2MBï¼ˆæµ®åŠ¨çª—å£ï¼‰ |
| é¦–æ¬¡æ˜¾ç¤ºå»¶è¿Ÿ | ç­‰å¾…æ¶ˆæ¯ | 0ms | âœ… ç«‹å³æ˜¾ç¤º |

**ç»“è®º**: æ€§èƒ½å½±å“å¯å¿½ç•¥ï¼Œç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡ã€‚

---

## ğŸ‰ æ€»ç»“

### é—®é¢˜
- æµ®åŠ¨çª—å£éœ€è¦ç­‰å¾…æ¶ˆæ¯è§¦å‘æ‰æ˜¾ç¤ºï¼Œä¸ç¬¦åˆ"å¸¸é©»æ˜¾ç¤º"éœ€æ±‚

### è§£å†³æ–¹æ¡ˆ
- åœ¨ `initialize()` æ—¶ç«‹å³åˆ›å»ºæµ®åŠ¨çª—å£
- åŠ è½½æ‰€æœ‰è¯æœ¯å¹¶æ˜¾ç¤º
- æ¶ˆæ¯åŒ¹é…æ—¶æ›´æ–°è¯æœ¯ï¼Œè€Œéåˆ›å»ºçª—å£

### æ•ˆæœ
- âœ… åº”ç”¨å¯åŠ¨å³æ˜¾ç¤ºæµ®åŠ¨çª—å£
- âœ… ç¬¦åˆç”¨æˆ·"å¸¸é©»æ˜¾ç¤º"éœ€æ±‚
- âœ… åŠ¨æ€æ›´æ–°ï¼šåŒ¹é…è¯æœ¯ â†” å…¨éƒ¨è¯æœ¯
- âœ… æ€§èƒ½å½±å“å¯å¿½ç•¥

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-10-02  
**ä¿®å¤äººå‘˜**: AI Assistant  
**çŠ¶æ€**: âœ… å·²ä¿®å¤å¹¶æµ‹è¯•éªŒè¯  
**ç”¨æˆ·ç¡®è®¤**: å¾…æµ‹è¯•

