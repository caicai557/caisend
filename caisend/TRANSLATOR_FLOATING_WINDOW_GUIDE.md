# 易翻译浮动窗口使用指南

**版本**: 1.0.0  
**创建日期**: 2025-10-02  
**功能**: 浮动窗口吸附到易翻译窗口

---

## 🎯 功能概述

浮动窗口现在支持**两种吸附模式**：
1. **Telegram模式** - 浮动窗口吸附到Telegram窗口
2. **易翻译模式** - 浮动窗口吸附到易翻译窗口（推荐）

---

## ⚙️ 配置

### 配置文件: `config.py`

```python
# UI配置
UI_CONFIG = {
    # ... 其他配置 ...
    
    # 浮动窗口吸附目标: 'telegram' 或 'translator'
    'attach_target': 'translator',  # 默认吸附到易翻译
    
    # 无匹配时是否显示全部话术
    'show_all_when_no_match': True
}
```

### 配置说明

| 配置项 | 可选值 | 默认值 | 说明 |
|--------|--------|--------|------|
| `attach_target` | `'telegram'` / `'translator'` | `'translator'` | 浮动窗口吸附目标 |
| `show_all_when_no_match` | `True` / `False` | `True` | 无匹配时是否显示所有话术 |

---

## 🚀 快速开始

### 1. 启动易翻译

确保易翻译应用已打开并处于可见状态。

### 2. 启动应用

```bash
python main.py
```

### 3. 观察启动日志

```
[AppController] 浮动窗口吸附目标: translator
[AppController] 无匹配显示全部: True
[启动] 初始化AppController系统...
[成功] 系统托盘已启动
[成功] 应用控制器初始化完成
[启动] 启动CDP消息捕获...
[CDP] 找到 Telegram 标签页: ...
[成功] CDP消息捕获器已启动
[提示] 易翻译浮动窗口控制器将在首次匹配话术时启动
```

### 4. 触发浮动窗口

在Telegram输入消息，有匹配话术时浮动窗口会自动显示。

如果无匹配，会显示所有话术（最多50条，按优先级和使用次数排序）。

---

## 📐 功能特性

### ✅ 1. 智能吸附

**吸附位置**: 易翻译窗口下方居中

```
┌──────────────────────────────────────┐
│         易翻译窗口                    │
│                                      │
└──────────────────────────────────────┘
            ↓ 10px 间距
    ┌───────────────────────┐
    │   浮动窗口 (话术列表)  │
    │                       │
    └───────────────────────┘
```

### ✅ 2. 实时跟随

- 拖动易翻译窗口时，浮动窗口自动跟随
- 延迟 < 100ms（防抖动50ms）
- 平滑移动，无闪烁

### ✅ 3. 焦点管理

| 事件 | 浮动窗口行为 |
|------|-------------|
| 易翻译激活 | ✅ 显示并重新吸附 |
| 易翻译失焦 | ❌ 隐藏 |
| 用户拖动浮动窗口 | ⏸️ 暂停自动吸附 |
| 易翻译重新激活 | ✅ 重置拖动标志，重新吸附 |

### ✅ 4. 边界智能调整

当浮动窗口会超出屏幕时，自动调整位置：

| 场景 | 调整策略 |
|------|---------|
| 底部溢出 | 移至易翻译上方 |
| 左侧溢出 | 对齐屏幕左边缘+10px |
| 右侧溢出 | 对齐屏幕右边缘-宽度-10px |

### ✅ 5. 多显示器支持

- 自动检测易翻译所在显示器
- 边界检测基于目标显示器工作区
- 支持DPI缩放（100%-300%）

---

## 🎨 交互特性

### 可调整大小

- **四边和四角**: 可拖拽调整
- **最小尺寸**: 300×100px
- **最大尺寸**: 800×600px
- **默认尺寸**: 400×200px
- **大小记忆**: 保存到配置文件

### 可拖动

- **拖动手柄**: 16px高拖动条（顶部）
- **拖动行为**: 
  - 拖动时暂停自动吸附
  - 易翻译重新激活时重置，重新吸附

### 可最小化

- **方式1**: 点击右上角 "−" 按钮
- **方式2**: 快捷键 `Ctrl+M`
- **目标**: 隐藏到系统托盘
- **恢复**: 右键托盘图标 → "显示浮动窗口"

---

## 📊 显示策略

### 有匹配话术

显示匹配到的话术（按相关度排序）

```python
# 示例：用户输入 "你好"
浮动窗口显示:
  1. 你好，欢迎使用我们的服务
  2. 你好，请问有什么可以帮助您的？
  3. 你好，很高兴为您服务
```

### 无匹配话术

如果 `show_all_when_no_match = True`，显示所有话术（最多50条）

```python
# 示例：用户输入 "xyz"（无匹配）
浮动窗口显示:
  全部话术列表 (按优先级和使用次数排序)
  1. 常用话术1
  2. 常用话术2
  ...
  50. 话术50
```

如果 `show_all_when_no_match = False`，不显示浮动窗口

---

## 🔧 高级配置

### 切换吸附模式

#### 切换到 Telegram 模式

```python
# config.py
UI_CONFIG = {
    'attach_target': 'telegram',  # 改为 telegram
}
```

重启应用后生效。

#### 切换到易翻译模式

```python
# config.py
UI_CONFIG = {
    'attach_target': 'translator',  # 改为 translator
}
```

重启应用后生效。

### 禁用"无匹配显示全部"

```python
# config.py
UI_CONFIG = {
    'show_all_when_no_match': False,  # 改为 False
}
```

重启后，无匹配时不显示浮动窗口。

---

## 🐛 故障排除

### 问题1: 浮动窗口不显示

**可能原因**:
1. 易翻译未运行或不可见
2. 无匹配话术且 `show_all_when_no_match = False`
3. 易翻译不在前台

**解决方案**:
1. 确保易翻译窗口打开且可见
2. 检查配置 `show_all_when_no_match`
3. 切换到易翻译窗口

### 问题2: 浮动窗口不跟随易翻译移动

**可能原因**:
1. 手动拖动了浮动窗口（触发暂停机制）
2. 控制器未启动

**解决方案**:
1. 切换到其他窗口，再切回易翻译（重置拖动标志）
2. 检查启动日志，确认控制器已启动

### 问题3: 浮动窗口位置错误

**可能原因**:
1. 多显示器DPI不一致
2. 屏幕边界计算错误

**解决方案**:
1. 重启应用
2. 检查显示器DPI设置
3. 查看日志中的位置计算信息

---

## 📝 日志示例

### 正常启动

```
[AppController] 浮动窗口吸附目标: translator
[AppController] 无匹配显示全部: True
[TranslatorMonitor] 检测到前台易翻译窗口 (耗时: 15.2ms)
[TranslatorMonitor] 已锁定易翻译窗口: 易翻译 (hwnd=196744)
[TranslatorController] 易翻译浮动窗口控制器已初始化
[TranslatorController] 启动易翻译浮动窗口智能定位...
[TranslatorMonitor] 监控已启动 (前台钩子=12345, 位置钩子=12346)
[AppController] 易翻译浮动窗口已创建 (9条话术)
```

### 窗口激活

```
[TranslatorMonitor] 易翻译窗口激活: hwnd=196744
[TranslatorController] 易翻译窗口激活: hwnd=196744
[TranslatorController] 浮动窗口位置更新: (235, 973) | 策略: below_centered
```

### 窗口移动

```
[TranslatorMonitor] 易翻译窗口移动: (300, 100, 1561, 979)
[TranslatorController] 浮动窗口位置更新: (300, 989) | 策略: below_centered
```

### 窗口失焦

```
[TranslatorMonitor] 易翻译窗口失焦: hwnd=196744
[TranslatorController] 易翻译窗口失焦: hwnd=196744
```

---

## 🎯 测试验证

### 手动测试脚本

```bash
python test_translator_attach.py
```

这个脚本会：
1. 创建测试浮动窗口（9条话术）
2. 启动易翻译控制器
3. 显示测试说明

### 测试场景

| 场景 | 预期行为 | 验证方法 |
|------|---------|---------|
| 应用启动 | 浮动窗口显示在易翻译下方 | 观察位置 |
| 拖动易翻译 | 浮动窗口实时跟随 | 拖动窗口 |
| 切换到其他窗口 | 浮动窗口隐藏 | 切换焦点 |
| 切回易翻译 | 浮动窗口重新显示并重新吸附 | 切换焦点 |
| 手动拖动浮动窗口 | 暂停自动吸附 | 拖动窗口 |
| 切回易翻译 | 重新吸附（重置拖动标志） | 切换焦点 |

---

## 📚 技术架构

```
TranslatorFloatingController (控制器)
├── TranslatorWindowMonitor (窗口监控)
│   ├── 检测易翻译窗口
│   ├── 监听激活/移动/失焦事件
│   └── 触发回调 (Win32 SetWinEventHook)
├── MonitorManager (显示器管理)
│   ├── 枚举所有显示器
│   ├── 获取工作区边界
│   └── DPI缩放处理
└── PositionCalculator (位置计算)
    ├── 计算默认位置（下方居中）
    ├── 检测边界溢出
    └── 返回调整后坐标
```

---

## 📖 相关文档

- **完整分析报告**: `COMPREHENSIVE_PROJECT_ANALYSIS.md`
- **交互特性规范**: `specs/floating-window-interactive-features/`
- **智能定位规范**: `specs/floating-window-smart-positioning/`
- **README**: `README.md`

---

**文档更新时间**: 2025-10-02  
**维护人员**: AI Assistant  
**状态**: ✅ 已完成并测试

