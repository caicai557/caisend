吸附功能核心代码
1. 吸附窗口类 (AdsorbSearchBox.cs)

using System;
using System.Runtime.InteropServices;
using System.Windows;
using System.Windows.Input;
using System.Windows.Interop;
using System.Windows.Threading;

namespace YourApp.Controls
{
    public class AdsorbSearchBox : Window
    {
        #region Win32 API
        [DllImport("user32.dll")]
        private static extern IntPtr GetForegroundWindow();

        [DllImport("user32.dll")]
        private static extern bool GetWindowRect(IntPtr hWnd, out RECT lpRect);

        [DllImport("user32.dll")]
        private static extern int GetWindowText(IntPtr hWnd, System.Text.StringBuilder lpString, int nMaxCount);

        [DllImport("user32.dll")]
        private static extern bool IsWindowVisible(IntPtr hWnd);

        [DllImport("user32.dll")]
        private static extern IntPtr GetWindow(IntPtr hWnd, uint uCmd);

        [DllImport("user32.dll")]
        private static extern uint GetWindowThreadProcessId(IntPtr hWnd, out uint lpdwProcessId);

        [StructLayout(LayoutKind.Sequential)]
        private struct RECT
        {
            public int Left;
            public int Top;
            public int Right;
            public int Bottom;
        }

        private const uint GW_HWNDNEXT = 2;
        #endregion

        private readonly DispatcherTimer _monitorTimer;
        private readonly DispatcherTimer _hideTimer;
        private IntPtr _lastForegroundWindow = IntPtr.Zero;
        private bool _isManuallyPositioned = false;
        private bool _isDragging = false;
        private Point _dragStartPoint;

        // 吸附配置
        private const double ADSORB_THRESHOLD = 15.0; // 吸附阈值
        private const double AUTO_HIDE_DELAY = 3000;  // 自动隐藏延迟(ms)
        private readonly string[] TARGET_WINDOW_KEYWORDS = { "微信", "QQ", "钉钉", "企业微信", "WeChat", "Telegram" };

        public event EventHandler<string> SearchTextChanged;
        public event EventHandler<string> SearchSubmitted;

        public AdsorbSearchBox()
        {
            InitializeWindow();
            InitializeTimers();
            SetupEventHandlers();
        }

        private void InitializeWindow()
        {
            // 窗口基本设置
            this.Width = 300;
            this.Height = 40;
            this.WindowStyle = WindowStyle.None;
            this.AllowsTransparency = true;
            this.Background = System.Windows.Media.Brushes.Transparent;
            this.Topmost = true;
            this.ShowInTaskbar = false;
            this.ResizeMode = ResizeMode.NoResize;

            // 创建搜索框UI
            CreateSearchBoxUI();
        }

        private void CreateSearchBoxUI()
        {
            var border = new System.Windows.Controls.Border
            {
                Background = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromArgb(240, 255, 255, 255)),
                BorderBrush = new System.Windows.Media.SolidColorBrush(System.Windows.Media.Color.FromArgb(180, 0, 120, 215)),
                BorderThickness = new Thickness(1),
                CornerRadius = new CornerRadius(20),
                Effect = new System.Windows.Media.Effects.DropShadowEffect
                {
                    Color = System.Windows.Media.Colors.Gray,
                    Direction = 270,
                    ShadowDepth = 2,
                    BlurRadius = 8,
                    Opacity = 0.3
                }
            };

            var textBox = new System.Windows.Controls.TextBox
            {
                Name = "SearchTextBox",
                Background = System.Windows.Media.Brushes.Transparent,
                BorderThickness = new Thickness(0),
                Padding = new Thickness(15, 8),
                FontSize = 14,
                VerticalAlignment = VerticalAlignment.Center,
                Text = "输入搜索内容..."
            };

            // 添加水印效果
            textBox.GotFocus += (s, e) => {
                if (textBox.Text == "输入搜索内容...")
                {
                    textBox.Text = "";
                    textBox.Foreground = System.Windows.Media.Brushes.Black;
                }
            };

            textBox.LostFocus += (s, e) => {
                if (string.IsNullOrWhiteSpace(textBox.Text))
                {
                    textBox.Text = "输入搜索内容...";
                    textBox.Foreground = System.Windows.Media.Brushes.Gray;
                }
            };

            textBox.TextChanged += (s, e) => {
                if (textBox.Text != "输入搜索内容...")
                {
                    SearchTextChanged?.Invoke(this, textBox.Text);
                    ResetHideTimer();
                }
            };

            textBox.KeyDown += (s, e) => {
                if (e.Key == Key.Enter)
                {
                    SearchSubmitted?.Invoke(this, textBox.Text);
                    this.Hide();
                }
                else if (e.Key == Key.Escape)
                {
                    this.Hide();
                }
            };

            border.Child = textBox;
            this.Content = border;

            // 设置初始水印样式
            textBox.Foreground = System.Windows.Media.Brushes.Gray;
        }

        private void InitializeTimers()
        {
            // 窗口监控计时器
            _monitorTimer = new DispatcherTimer
            {
                Interval = TimeSpan.FromMilliseconds(100)
            };
            _monitorTimer.Tick += MonitorTimer_Tick;

            // 自动隐藏计时器
            _hideTimer = new DispatcherTimer
            {
                Interval = TimeSpan.FromMilliseconds(AUTO_HIDE_DELAY)
            };
            _hideTimer.Tick += (s, e) => {
                _hideTimer.Stop();
                if (!this.IsMouseOver && !this.IsFocused)
                {
                    this.Hide();
                }
            };
        }

        private void SetupEventHandlers()
        {
            this.MouseLeftButtonDown += AdsorbSearchBox_MouseLeftButtonDown;
            this.MouseMove += AdsorbSearchBox_MouseMove;
            this.MouseLeftButtonUp += AdsorbSearchBox_MouseLeftButtonUp;
            this.MouseEnter += (s, e) => _hideTimer.Stop();
            this.MouseLeave += (s, e) => StartHideTimer();
            this.LostFocus += (s, e) => StartHideTimer();
        }

        #region 拖拽功能
        private void AdsorbSearchBox_MouseLeftButtonDown(object sender, MouseButtonEventArgs e)
        {
            _isDragging = true;
            _dragStartPoint = e.GetPosition(this);
            _isManuallyPositioned = true;
            this.CaptureMouse();
            _hideTimer.Stop();
        }

        private void AdsorbSearchBox_MouseMove(object sender, MouseEventArgs e)
        {
            if (_isDragging && e.LeftButton == MouseButtonState.Pressed)
            {
                var currentPoint = e.GetPosition(this);
                var deltaX = currentPoint.X - _dragStartPoint.X;
                var deltaY = currentPoint.Y - _dragStartPoint.Y;

                this.Left += deltaX;
                this.Top += deltaY;

                // 边缘吸附检测
                PerformEdgeAdsorption();
            }
        }

        private void AdsorbSearchBox_MouseLeftButtonUp(object sender, MouseButtonEventArgs e)
        {
            _isDragging = false;
            this.ReleaseMouseCapture();
            StartHideTimer();
        }
        #endregion

        #region 核心吸附逻辑
        private void MonitorTimer_Tick(object sender, EventArgs e)
        {
            if (_isManuallyPositioned || _isDragging) return;

            try
            {
                var foregroundWindow = GetForegroundWindow();
                if (foregroundWindow == IntPtr.Zero || foregroundWindow == _lastForegroundWindow) 
                    return;

                _lastForegroundWindow = foregroundWindow;

                if (IsTargetWindow(foregroundWindow))
                {
                    ShowAndPositionNearWindow(foregroundWindow);
                }
                else
                {
                    StartHideTimer();
                }
            }
            catch
            {
                // 忽略异常，继续监控
            }
        }

        private bool IsTargetWindow(IntPtr hWnd)
        {
            if (!IsWindowVisible(hWnd)) return false;

            var windowTitle = GetWindowTitle(hWnd);
            if (string.IsNullOrEmpty(windowTitle)) return false;

            foreach (var keyword in TARGET_WINDOW_KEYWORDS)
            {
                if (windowTitle.Contains(keyword))
                    return true;
            }

            return false;
        }

        private string GetWindowTitle(IntPtr hWnd)
        {
            var buffer = new System.Text.StringBuilder(256);
            GetWindowText(hWnd, buffer, buffer.Capacity);
            return buffer.ToString();
        }

        private void ShowAndPositionNearWindow(IntPtr targetWindow)
        {
            if (!GetWindowRect(targetWindow, out RECT windowRect)) return;

            var screenWidth = SystemParameters.PrimaryScreenWidth;
            var screenHeight = SystemParameters.PrimaryScreenHeight;

            // 计算最佳位置（目标窗口右上角）
            var newLeft = Math.Min(windowRect.Right + 10, screenWidth - this.Width);
            var newTop = Math.Max(windowRect.Top, 0);

            // 确保不超出屏幕边界
            if (newLeft < 0) newLeft = windowRect.Left - this.Width - 10;
            if (newTop + this.Height > screenHeight) newTop = screenHeight - this.Height;

            this.Left = newLeft;
            this.Top = newTop;

            if (!this.IsVisible)
            {
                this.Show();
                FocusSearchBox();
            }

            _hideTimer.Stop();
        }

        private void PerformEdgeAdsorption()
        {
            var screenWidth = SystemParameters.PrimaryScreenWidth;
            var screenHeight = SystemParameters.PrimaryScreenHeight;

            // 左边缘吸附
            if (this.Left <= ADSORB_THRESHOLD)
            {
                this.Left = 0;
            }
            // 右边缘吸附
            else if (this.Left + this.Width >= screenWidth - ADSORB_THRESHOLD)
            {
                this.Left = screenWidth - this.Width;
            }

            // 顶部边缘吸附
            if (this.Top <= ADSORB_THRESHOLD)
            {
                this.Top = 0;
            }
            // 底部边缘吸附
            else if (this.Top + this.Height >= screenHeight - ADSORB_THRESHOLD)
            {
                this.Top = screenHeight - this.Height;
            }
        }
        #endregion

        #region 公共方法
        public void StartMonitoring()
        {
            _monitorTimer.Start();
        }

        public void StopMonitoring()
        {
            _monitorTimer.Stop();
            _hideTimer.Stop();
        }

        public void ShowAtPosition(double x, double y)
        {
            this.Left = x;
            this.Top = y;
            _isManuallyPositioned = true;
            this.Show();
            FocusSearchBox();
            ResetHideTimer();
        }

        public void FocusSearchBox()
        {
            if (this.Content is System.Windows.Controls.Border border && 
                border.Child is System.Windows.Controls.TextBox textBox)
            {
                textBox.Focus();
                textBox.SelectAll();
            }
        }

        private void StartHideTimer()
        {
            _hideTimer.Stop();
            _hideTimer.Start();
        }

        private void ResetHideTimer()
        {
            _hideTimer.Stop();
            _hideTimer.Start();
        }

        public void ResetPosition()
        {
            _isManuallyPositioned = false;
        }
        #endregion

        protected override void OnClosed(EventArgs e)
        {
            StopMonitoring();
            base.OnClosed(e);
        }
    }
}

2. 使用示例 (MainWindow.cs)

 using System;
using System.Windows;
using YourApp.Controls;

namespace YourApp
{
    public partial class MainWindow : Window
    {
        private AdsorbSearchBox _adsorbSearchBox;

        public MainWindow()
        {
            InitializeComponent();
            InitializeAdsorbSearchBox();
        }

        private void InitializeAdsorbSearchBox()
        {
            _adsorbSearchBox = new AdsorbSearchBox();
            
            // 订阅搜索事件
            _adsorbSearchBox.SearchTextChanged += AdsorbSearchBox_SearchTextChanged;
            _adsorbSearchBox.SearchSubmitted += AdsorbSearchBox_SearchSubmitted;
            
            // 开始监控
            _adsorbSearchBox.StartMonitoring();
        }

        private void AdsorbSearchBox_SearchTextChanged(object sender, string searchText)
        {
            // 实时搜索处理
            if (!string.IsNullOrWhiteSpace(searchText))
            {
                PerformSearch(searchText);
            }
        }

        private void AdsorbSearchBox_SearchSubmitted(object sender, string searchText)
        {
            // 搜索确认处理
            if (!string.IsNullOrWhiteSpace(searchText))
            {
                PerformSearch(searchText);
                // 可以在这里执行特定的搜索结果处理
            }
        }

        private void PerformSearch(string searchText)
        {
            // 在这里实现您的搜索逻辑
            Console.WriteLine($"搜索: {searchText}");
            
            // 例如：搜索短语、文件、联系人等
            // var results = SearchService.Search(searchText);
            // DisplaySearchResults(results);
        }

        // 手动显示搜索框的方法
        private void ShowSearchBox_Click(object sender, RoutedEventArgs e)
        {
            var mousePosition = System.Windows.Input.Mouse.GetPosition(this);
            var screenPosition = this.PointToScreen(mousePosition);
            _adsorbSearchBox.ShowAtPosition(screenPosition.X, screenPosition.Y);
        }

        // 全局快捷键触发搜索框
        private void GlobalHotkey_Triggered()
        {
            // 在屏幕中央显示搜索框
            var screenWidth = SystemParameters.PrimaryScreenWidth;
            var screenHeight = SystemParameters.PrimaryScreenHeight;
            var centerX = (screenWidth - _adsorbSearchBox.Width) / 2;
            var centerY = (screenHeight - _adsorbSearchBox.Height) / 2;
            
            _adsorbSearchBox.ShowAtPosition(centerX, centerY);
        }

        protected override void OnClosed(EventArgs e)
        {
            _adsorbSearchBox?.StopMonitoring();
            _adsorbSearchBox?.Close();
            base.OnClosed(e);
        }
    }
}

3. 配置类 (AdsorbConfig.cs)

namespace YourApp.Config
{
    public class AdsorbConfig
    {
        public bool IsEnabled { get; set; } = true;
        public double AdsorbThreshold { get; set; } = 15.0;
        public double AutoHideDelay { get; set; } = 3000;
        public string[] TargetWindowKeywords { get; set; } = { "微信", "QQ", "钉钉", "企业微信" };
        public double SearchBoxWidth { get; set; } = 300;
        public double SearchBoxHeight { get; set; } = 40;
        public bool EnableAutoShow { get; set; } = true;
        public bool EnableManualDrag { get; set; } = true;
    }
}